openapi: 3.0.0
info:
  title: DigiKas API Documentation
  description: Dokumentasi API lengkap untuk aplikasi Uang Kas Digital (DigiKas) berbasis Next.js 15 & Supabase.
  version: 1.0.0
servers:
  - url: http://localhost:3000/api
    description: Development Server
  - url: https://uang-kas-digital.vercel.app/api
    description: Production Server

components:
  securitySchemes:
    # Karena pakai localStorage, autentikasi di handle di frontend
    # tapi kita bisa definisikan skema user session jika perlu
    ApiKeyAuth:
      type: apiKey
      in: header
      name: Authorization

  schemas:
    User:
      type: object
      properties:
        id:
          type: integer
          example: 1
        nim:
          type: string
          example: "21120123130068"
        nama_lengkap:
          type: string
          example: "Budi Santoso"
        role:
          type: string
          enum: [ADMIN, MAHASISWA]
          example: "MAHASISWA"
        prodi:
          type: string
          example: "Teknik Komputer"
        fakultas:
          type: string
          example: "Teknik"
        angkatan:
          type: string
          example: "2023"
        no_hp:
          type: string
          example: "081234567890"
        email:
          type: string
          format: email
          example: "budi@example.com"
        tanggal_lahir:
          type: string
          format: date
          example: "2003-05-20"

    Transaction:
      type: object
      properties:
        id:
          type: integer
          example: 101
        user_id:
          type: integer
          example: 1
        tipe:
          type: string
          enum: [PEMASUKAN, PENGELUARAN]
          example: "PEMASUKAN"
        nominal:
          type: number
          example: 50000
        keterangan:
          type: string
          example: "Iuran Bulan November 2025"
        bukti_bayar:
          type: string
          format: uri
          nullable: true
          example: "https://supabase.co/storage/v1/object/public/bukti-bayar/img.jpg"
        status:
          type: string
          enum: [PENDING, VERIFIED, REJECTED]
          example: "PENDING"
        tanggal_transaksi:
          type: string
          format: date-time
          example: "2025-11-20T10:00:00Z"
        users:
          $ref: "#/components/schemas/User"

    PaginationMeta:
      type: object
      properties:
        total:
          type: integer
          example: 50
        page:
          type: integer
          example: 1
        limit:
          type: integer
          example: 10
        totalPages:
          type: integer
          example: 5

paths:
  # --------------------------
  # AUTHENTICATION
  # --------------------------
  /auth/login:
    post:
      summary: Login User
      description: Autentikasi untuk Admin dan Mahasiswa menggunakan NIM dan Password.
      tags: [Authentication]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [nim, password]
              properties:
                nim:
                  type: string
                  example: "123456"
                password:
                  type: string
                  example: "12345620030520"
      responses:
        200:
          description: Login berhasil
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Login berhasil"
                  user:
                    $ref: "#/components/schemas/User"
        401:
          description: Password salah
        404:
          description: User tidak ditemukan

  # --------------------------
  # DASHBOARD
  # --------------------------
  /dashboard:
    get:
      summary: Get Admin Dashboard Stats
      description: Mengembalikan ringkasan total pemasukan, pengeluaran, dan saldo kas saat ini.
      tags: [Dashboard]
      responses:
        200:
          description: Berhasil mengambil data statistik
          content:
            application/json:
              schema:
                type: object
                properties:
                  total_pemasukan:
                    type: number
                    example: 15000000
                  total_pengeluaran:
                    type: number
                    example: 5000000
                  saldo_kas:
                    type: number
                    example: 10000000

  /dashboard/chart:
    get:
      summary: Get Chart Data (Bulanan)
      description: Data agregasi pemasukan vs pengeluaran per bulan untuk tahun berjalan.
      tags: [Dashboard]
      responses:
        200:
          description: Array data grafik
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    name:
                      type: string
                      example: "Jan"
                    pemasukan:
                      type: number
                      example: 500000
                    pengeluaran:
                      type: number
                      example: 200000

  /student/dashboard:
    get:
      summary: Get Student Personal Dashboard
      description: Statistik khusus mahasiswa (Saldo Angkatan, Pengeluaran Global, Kontribusi Pribadi).
      tags: [Dashboard]
      parameters:
        - in: query
          name: user_id
          required: true
          schema:
            type: integer
          description: ID dari mahasiswa yang sedang login
      responses:
        200:
          description: Data dashboard personal
          content:
            application/json:
              schema:
                type: object
                properties:
                  stats:
                    type: object
                    properties:
                      saldo_angkatan:
                        type: number
                      total_pengeluaran:
                        type: number
                      uang_saya:
                        type: number
                  chart_data:
                    type: array
                    items:
                      type: object
                      properties:
                        name:
                          type: string
                        pemasukan_angkatan:
                          type: number
                        pengeluaran_angkatan:
                          type: number
                        bayaran_saya:
                          type: number

  # --------------------------
  # MANAJEMEN MAHASISWA
  # --------------------------
  /mahasiswa:
    get:
      summary: Get All Mahasiswa
      description: Mengambil daftar mahasiswa dengan fitur paginasi.
      tags: [Mahasiswa]
      parameters:
        - in: query
          name: page
          schema:
            type: integer
            default: 1
        - in: query
          name: limit
          schema:
            type: integer
            default: 10
      responses:
        200:
          description: List data mahasiswa
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/User"
                  meta:
                    $ref: "#/components/schemas/PaginationMeta"

    post:
      summary: Create New Mahasiswa
      description: Admin menambahkan data mahasiswa baru. Password default di-generate (NIM + DDMMYYYY).
      tags: [Mahasiswa]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                nim:
                  type: string
                nama_lengkap:
                  type: string
                fakultas:
                  type: string
                prodi:
                  type: string
                angkatan:
                  type: string
                tanggal_lahir:
                  type: string
                  format: date
                  description: YYYY-MM-DD
                no_hp:
                  type: string
                email:
                  type: string
      responses:
        201:
          description: Mahasiswa berhasil ditambahkan
        409:
          description: NIM sudah terdaftar

  /mahasiswa/{id}:
    put:
      summary: Update Mahasiswa
      tags: [Mahasiswa]
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/User"
      responses:
        200:
          description: Data berhasil diperbarui

    delete:
      summary: Delete Mahasiswa
      tags: [Mahasiswa]
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      responses:
        200:
          description: User berhasil dihapus

  # --------------------------
  # TRANSAKSI & KAS
  # --------------------------
  /transaksi:
    get:
      summary: Get Transactions List
      description: Mengambil daftar transaksi dengan filter lengkap (Search, Tipe, Status, User).
      tags: [Transaksi]
      parameters:
        - in: query
          name: page
          schema:
            type: integer
            default: 1
        - in: query
          name: limit
          schema:
            type: integer
            default: 10
        - in: query
          name: search
          schema:
            type: string
          description: Cari berdasarkan nama mahasiswa
        - in: query
          name: tipe
          schema:
            type: string
            enum: [PEMASUKAN, PENGELUARAN, ALL]
        - in: query
          name: status
          schema:
            type: string
            enum: [PENDING, VERIFIED, REJECTED]
        - in: query
          name: user_id
          schema:
            type: integer
          description: Filter transaksi milik user tertentu
      responses:
        200:
          description: List transaksi ditemukan
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/Transaction"
                  meta:
                    $ref: "#/components/schemas/PaginationMeta"

    post:
      summary: Create Transaction (Input Kas/Bayar)
      description: Mencatat pemasukan (Setor Kas) atau pengeluaran. Memiliki validasi saldo untuk pengeluaran.
      tags: [Transaksi]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                user_id:
                  type: integer
                tipe:
                  type: string
                  enum: [PEMASUKAN, PENGELUARAN]
                nominal:
                  type: number
                keterangan:
                  type: string
                bukti_bayar:
                  type: string
                  description: Public URL dari Supabase Storage
                status:
                  type: string
                  enum: [PENDING, VERIFIED]
                  description: Admin = VERIFIED, Mhs = PENDING
      responses:
        200:
          description: Transaksi berhasil disimpan
        400:
          description: Saldo kas tidak cukup (untuk pengeluaran)

  /transaksi/{id}:
    get:
      summary: Get Transaction Detail
      tags: [Transaksi]
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      responses:
        200:
          description: Detail transaksi ditemukan
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Transaction"

    put:
      summary: Update Transaction (Verify/Reject)
      description: Admin memverifikasi atau menolak setoran. Bisa juga update keterangan (alasan penolakan).
      tags: [Transaksi]
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                status:
                  type: string
                  enum: [VERIFIED, REJECTED]
                keterangan:
                  type: string
                  description: "Opsional: Update keterangan (misal alasan ditolak)"
      responses:
        200:
          description: Status transaksi diperbarui
